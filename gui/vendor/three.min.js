(function(){
  if (typeof window === 'undefined') return;
  var degToRad = Math.PI / 180;
  function clamp(v,min,max){return v<min?min:v>max?max:v;}
  function Vector2(x,y){this.x=x||0;this.y=y||0;}
  Vector2.prototype.set=function(x,y){this.x=x;this.y=y;return this;};
  function Vector3(x,y,z){this.x=x||0;this.y=y||0;this.z=z||0;}
  Vector3.prototype.set=function(x,y,z){this.x=x;this.y=y;this.z=z;return this;};
  function Color(hex){this.set(hex||0);} Color.prototype.set=function(hex){this.hex=hex>>>0;return this;};
  function Object3D(){this.children=[];this.position=new Vector3();this.rotation=new Vector3();}
  Object3D.prototype.add=function(child){if(child&&child!==this){this.children.push(child);}return this;};
  function Scene(){Object3D.call(this);}Scene.prototype=Object.create(Object3D.prototype);Scene.prototype.constructor=Scene;
  function PerspectiveCamera(fov,aspect,near,far){Object3D.call(this);this.fov=fov||50;this.aspect=aspect||1;this.near=near||0.1;this.far=far||2000;}
  PerspectiveCamera.prototype=Object.create(Object3D.prototype);PerspectiveCamera.prototype.constructor=PerspectiveCamera;
  PerspectiveCamera.prototype.updateProjectionMatrix=function(){};
  function Geometry(){this.type='Geometry';}
  function SphereGeometry(radius, widthSegments, heightSegments){Geometry.call(this);this.radius=radius||1;this.widthSegments=widthSegments||16;this.heightSegments=heightSegments||12;}
  SphereGeometry.prototype=Object.create(Geometry.prototype);SphereGeometry.prototype.constructor=SphereGeometry;
  function GridHelper(size, divisions){Object3D.call(this);this.size=size||10;this.divisions=divisions||10;}
  GridHelper.prototype=Object.create(Object3D.prototype);GridHelper.prototype.constructor=GridHelper;
  function Material(parameters){parameters=parameters||{};this.color=new Color(parameters.color||0xffffff);} 
  function MeshBasicMaterial(parameters){Material.call(this,parameters);} MeshBasicMaterial.prototype=Object.create(Material.prototype);MeshBasicMaterial.prototype.constructor=MeshBasicMaterial;
  function Mesh(geometry,material){Object3D.call(this);this.geometry=geometry||new Geometry();this.material=material||new Material();this.userData={};}
  Mesh.prototype=Object.create(Object3D.prototype);Mesh.prototype.constructor=Mesh;
  function Group(){Object3D.call(this);} Group.prototype=Object.create(Object3D.prototype);Group.prototype.constructor=Group;
  function AmbientLight(color,intensity){Object3D.call(this);this.color=new Color(color||0xffffff);this.intensity=intensity==null?1:intensity;} AmbientLight.prototype=Object.create(Object3D.prototype);AmbientLight.prototype.constructor=AmbientLight;
  function Raycaster(){this.rayOrigin=new Vector3();this.mouse=null;this.camera=null;}
  Raycaster.prototype.setFromCamera=function(mouse,camera){this.mouse=mouse;this.camera=camera;};
  Raycaster.prototype.intersectObjects=function(objects){
    var renderer=THREE.__lastRenderer;var results=[];if(!renderer||!this.mouse||!this.camera)return results;
    var width=renderer._width||1, height=renderer._height||1;
    var mx=(this.mouse.x*0.5+0.5)*width; var my=(-this.mouse.y*0.5+0.5)*height;
    var project=renderer.__projectToScreen;
    for(var i=0;i<objects.length;i++){
      var obj=objects[i];
      if(!obj || !obj.geometry || !(obj.geometry instanceof SphereGeometry)) continue;
      var screen=project(obj,this.camera);
      if(!screen) continue;
      var dx=mx-screen.x, dy=my-screen.y; var dist=Math.sqrt(dx*dx+dy*dy);
      var radius=screen.radius||10; if(dist<=radius){results.push({distance:dist,object:obj});}
    }
    results.sort(function(a,b){return a.distance-b.distance;});
    return results;
  };
  function WebGLRenderer(params){params=params||{};var canvas=document.createElement('canvas');this.domElement=canvas;this.context=canvas.getContext('2d');this._width=300;this._height=150;this._pixelRatio=1;THREE.__lastRenderer=this;}
  WebGLRenderer.prototype.setPixelRatio=function(r){this._pixelRatio=r||1;};
  WebGLRenderer.prototype.setSize=function(w,h){this._width=w;this._height=h;this.domElement.width=w*this._pixelRatio;this.domElement.height=h*this._pixelRatio;this.domElement.style.width=w+'px';this.domElement.style.height=h+'px';};
  WebGLRenderer.prototype.render=function(scene,camera){if(!scene||!camera)return;var ctx=this.context;var w=this.domElement.width;var h=this.domElement.height;ctx.clearRect(0,0,w,h);ctx.save();ctx.scale(this._pixelRatio,this._pixelRatio);
    var project=this.__projectToScreen.bind(this);
    var drawGrid=function(helper){ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;var size=helper.size||10;var divisions=helper.divisions||10;var half=size/2;for(var i=0;i<=divisions;i++){var t=-half+(size/divisions)*i;ctx.beginPath();ctx.moveTo(0+t, -half);ctx.lineTo(0+t, half);ctx.stroke();ctx.beginPath();ctx.moveTo(-half,0+t);ctx.lineTo(half,0+t);ctx.stroke();}};
    var drawObject=function(obj,parentRotation){if(!obj) return;var rotY=parentRotation||0;var currentRotation=rotY+(obj.rotation?obj.rotation.y:0);
      if(obj instanceof GridHelper){drawGrid(obj);} else if(obj instanceof Mesh && obj.geometry instanceof SphereGeometry){var s=project(obj,camera,currentRotation);if(s){ctx.beginPath();ctx.fillStyle='#'+('000000'+obj.material.color.hex.toString(16)).slice(-6);ctx.arc(s.x,s.y,s.radius||10,0,Math.PI*2);ctx.fill();}}
      var children=obj.children||[];for(var i=0;i<children.length;i++){drawObject(children[i],currentRotation);} };
    var children=scene.children||[];for(var i=0;i<children.length;i++){drawObject(children[i],0);} ctx.restore();};
  WebGLRenderer.prototype.__projectToScreen=function(obj,camera,parentRotation){var width=this._width,height=this._height;var rotY=parentRotation||0;var pos=obj.position||new Vector3();var x=pos.x, y=pos.y, z=pos.z;var cosY=Math.cos(rotY), sinY=Math.sin(rotY);var rx=x*cosY - z*sinY;var rz=x*sinY + z*cosY;var worldZ=(camera.position?camera.position.z:0)+rz;var worldX=rx+(camera.position?camera.position.x:0);var worldY=y+(camera.position?camera.position.y:0);var zpos=worldZ;if(zpos<=0.1) return null;var scale=(camera.fov?Math.tan((camera.fov*degToRad)/2):1);var projX=(worldX/(zpos*scale));var projY=(worldY/(zpos*scale));var sx=(projX*0.5+0.5)*width;var sy=(-projY*0.5+0.5)*height;var radius=10;if(obj.geometry && obj.geometry.radius){radius=clamp((obj.geometry.radius/zpos)*width*0.5,4,60);}return {x:sx,y:sy,radius:radius};};
  var THREE={Vector2:Vector2,Vector3:Vector3,Color:Color,Object3D:Object3D,Scene:Scene,PerspectiveCamera:PerspectiveCamera,Geometry:Geometry,SphereGeometry:SphereGeometry,GridHelper:GridHelper,Material:Material,MeshBasicMaterial:MeshBasicMaterial,Mesh:Mesh,Group:Group,AmbientLight:AmbientLight,Raycaster:Raycaster,WebGLRenderer:WebGLRenderer};
  window.THREE=THREE;
})();
